---
title: "Análise sobre o conjunto de dados do IMDB"
author: "Thales Henrique Barros Cardoso"
output:
  html_document:
    df_print: paged
---

# Análise dos dados do IMDB

O seu relatório deve (ao menos) responder as seguintes perguntas:

1. Qual o mês do ano com o maior número de filmes? E o dia do ano?

2. Qual o top 5 países com mais filmes na base?

3. Liste todas as moedas que aparecem nas colunas `orcamento` e `receita` da base `imdb_completa`.

4. Considerando apenas orçamentos e receitas em dólar ($), qual o gênero com maior lucro? E com maior nota média?

5. Dentre os filmes na base `imdb_completa`, escolha o seu favorito. Então faça os itens a seguir:

a) Quem dirigiu o filme? Faça uma ficha dessa pessoa: idade (hoje em dia ou data de falecimento), onde nasceu, quantos filmes já dirigiu, qual o lucro médio dos filmes que dirigiu (considerando apenas valores em dólar) e outras informações que achar interessante (base `imdb_pessoas`).

b) Qual a posição desse filme no ranking de notas do IMDB? E no ranking de lucro (considerando apenas valores em dólar)?

c) Em que dia esse filme foi lançado? E dia da semana? Algum outro filme foi lançado no mesmo dia? Quantos anos você tinha nesse dia?

d) Faça um gráfico representando a distribuição da nota atribuída a esse filme por idade (base `imdb_avaliacoes`).

```{r, include=FALSE}
library(magrittr)
library(sf)

# Leitura dos conjuntos de dados
#remotes::install_github("curso-r/basesCursoR")
imdb <- basesCursoR::pegar_base("imdb_completa")
imdb_pessoas <- basesCursoR::pegar_base("imdb_pessoas")
imdb_avaliacoes <- basesCursoR::pegar_base("imdb_avaliacoes")
```

Conforme solicitado, vamos responder as perguntas que foram sugeridas e acrescentar o que acharmos de interessante para a análise dos dados do IMDB.

```{r, include=FALSE}
# Transformação do conjunto IMDB
imdb <- imdb %>%
  tidyr::separate(
    col = receita,
    into = c("moeda_receita", "valor_receita"),
    sep = " ") %>%
  tidyr::separate(
    col = orcamento,
    into = c("moeda_orcamento", "valor_orcamento"),
    sep = " ") %>%
  dplyr::mutate(
    moeda_receita = dplyr::if_else(moeda_receita == "$", "USD", moeda_receita),
    moeda_orcamento = dplyr::if_else(moeda_orcamento == "$", "USD", moeda_orcamento),
    valor_receita = as.numeric(valor_receita),
    valor_orcamento = as.numeric(valor_orcamento),
    lucro = valor_receita - valor_orcamento,
    data_lancamento = lubridate::as_date(data_lancamento)
  )

# Transformação do conjunto de dados IMDB pessoas
imdb_pessoas <- imdb_pessoas %>% 
  dplyr::mutate(
    data_nascimento = lubridate::as_date(data_nascimento),
    data_falecimento = lubridate::as_date(data_falecimento)
  )
```

## 1. Qual o mês do ano com o maior número de filmes? E o dia do ano?

Primeiro vamos ver uma tabela com a quantidade de filmes lançados por mês.

```{r, echo=FALSE, results='asis'}
# Quantidade de filmes por mês
imdb %>%
  dplyr::mutate(
    Mes = lubridate::month(data_lancamento, label = TRUE, abbr = FALSE),
    Mes = stringr::str_to_title(Mes)
  ) %>%
  dplyr::filter(!is.na(data_lancamento)) %>%
  dplyr::count(Mes) %>%
  dplyr::arrange(desc(n)) %>% 
  dplyr::rename(Quantidade = n) %>% 
  knitr::kable()
```

Vamos visualizar através de um gráfico, para uma melhor comparação, qual o mês com maior número de filmes.

```{r, echo=FALSE, fig.align='center'}
imdb %>%
  dplyr::mutate(
    mes = lubridate::month(data_lancamento, 
                           label = TRUE, 
                           abbr = FALSE),
    mes = stringr::str_to_title(mes)
  ) %>%
  dplyr::filter(!is.na(data_lancamento)) %>%
  dplyr::count(mes) %>% 
  dplyr::rename(quantidade = n) %>% 
  ggplot2::ggplot(ggplot2::aes(
    fill = quantidade, 
    area = quantidade,
    label = paste(mes, quantidade, sep = "\n"))
  ) +
  treemapify::geom_treemap() +
  treemapify::geom_treemap_text(
    color = 'white', 
    size = 15
  ) +
  ggplot2::labs(
    title = 'Quantidade de filmes lançados por mês',
    caption = 'Fonte: IMDB',
  ) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      size = 22,
      face = "bold"),
    plot.caption = ggplot2::element_text(face = "italic"),
    legend.position = 'none'
  ) +
  ggplot2::scale_fill_viridis_c(alpha = 0.2, option = 'D')
```

Em seguida temos o dia do mes com mais filmes lançados.

```{r, echo=FALSE, results='asis'}
# Quantidade de filmes por dia
imdb %>%
  dplyr::mutate(
    Dia = lubridate::day(data_lancamento)
  ) %>%
  dplyr::filter(!is.na(data_lancamento)) %>%
  dplyr::count(Dia) %>%
  dplyr::arrange(desc(n)) %>% 
  dplyr::rename(Quantidade = n) %>% 
  knitr::kable()
```

E uma visualização para ver como se comportou os lançamentos dos filmes em relação aos dias do mês.

```{r, echo=FALSE, fig.align='center'}

g <- imdb %>%
  dplyr::mutate(
    dia = lubridate::day(data_lancamento)
  ) %>%
  dplyr::filter(!is.na(data_lancamento)) %>%
  dplyr::count(dia) %>%
  dplyr::rename(quantidade = n)
  
ggplot2::ggplot(
  data = g, 
  mapping = ggplot2::aes(x = dia, y = quantidade)
) +
  ggplot2::geom_line(
    stat = 'identity',
    size = 1,
    color = '#7FFFD4'
  ) +
  ggplot2::geom_point(
    stat = 'identity',
    size = 3,
    color = '#66CDAA'
  ) +
  ggrepel::geom_label_repel(
    data = subset(g, quantidade > 7000 | quantidade < 1500),
    ggplot2::aes(label = quantidade),
    nudge_x = 1.5,
    nudge_y = 1200
    ) +
  ggrepel::geom_label_repel(
    data = subset(g, quantidade > 2800 & quantidade < 2900),
    ggplot2::aes(label = quantidade),
    nudge_y = 800
  ) +
  ggplot2::theme_bw() +
  ggplot2::labs(
    title = 'Quantidade de filmes lançados por dia',
    x = 'Dia',
    y = 'Quantidade',
    caption = 'Fonte: IMDB'
  ) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      size = 22,
      face = "bold"),
    plot.caption = ggplot2::element_text(face = "italic"),
    axis.title.x = ggplot2::element_text(
      size = 12,
      face = "bold"),
    axis.title.y = ggplot2::element_text(
      size = 12,
      face = "bold"),
    axis.text.x = ggplot2::element_text(size = 12),
    axis.text.y = ggplot2::element_text(size = 12)
  ) 

```

Já que estamos visualizando quantos filmes por mês e por dia foram lançados, vamos aproveitar e verificar qaunto foi o total de lucro agrupando por mês os dados. Para este caso iremos utilizar filtrar apenas os dados onde a moeda da receita e do orçamento são dolares (USD).

```{r, echo=FALSE}

imdb %>% 
  dplyr::mutate(
    Mes = lubridate::month(data_lancamento, 
                           label = TRUE, 
                           abbr = FALSE),
    Mes = stringr::str_to_title(Mes)
  ) %>%
  dplyr::group_by(Mes) %>% 
  dplyr::filter(moeda_receita == 'USD' & moeda_orcamento == 'USD') %>% 
  dplyr::summarise(
    Lucro_por_mes = sum(lucro, na.rm = TRUE)
  ) %>% 
  dplyr::select(Mes, Lucro_por_mes) %>% 
  dplyr::filter(!is.na(Mes)) %>% 
  dplyr::arrange(desc(Lucro_por_mes)) %>% 
  knitr::kable()

```

Podemos ver a nuvens de palavras com os meses que mais e menos lucrativos. Em azul os meses com menores lucros e em vermelho aqueles que tiveram bons lucros.

```{r, fig.align='center', echo=FALSE}
imdb %>%
  dplyr::mutate(
    mes = lubridate::month(data_lancamento,
                           label = TRUE,
                           abbr = FALSE),
    mes = stringr::str_to_title(mes)
  ) %>%
  dplyr::group_by(mes) %>%
  dplyr::filter(moeda_receita == 'USD' & moeda_orcamento == 'USD') %>%
  dplyr::summarise(
    lucro_por_dia = sum(lucro, na.rm = TRUE)
  ) %>%
  dplyr::mutate(
    angle = 90 * sample(c(0, 1), dplyr::n(), replace = TRUE, prob = c(60, 40))
  ) %>%
  dplyr::filter(!is.na(mes)) %>%
  ggplot2::ggplot(ggplot2::aes(label = mes,
                               size = lucro_por_dia,
                               angle = angle,
                               color = lucro_por_dia)
  ) +
  ggwordcloud::geom_text_wordcloud_area(
    shape = 'square',
    seed = 100,
    area_corr_power = 1/0.5
  ) +
  ggplot2::scale_size_area(max_size = 18) +
  ggplot2::scale_color_gradient(
    low = '#0000FF', 
    high = '#FF0000') +
  ggplot2::theme_bw()
```

## 2. Qual o top 5 países com mais filmes na base?

Podemos ver através de uma tabela quais são os 5 países com mais filmes no conjunto de dados do IMDB.

```{r, echo=FALSE, fig.align='center', warning=FALSE}

sf_world <- giscoR::gisco_get_countries()

qte_filmes_pais <- imdb %>%
  tidyr::separate(
    col = pais,
    into = c("pais", "pais_2", "pais_3", "pais_4"),
    sep = ","
  ) %>%
  dplyr::mutate(
    pais_2 = NULL,
    pais_3 = NULL,
    pais_4 = NULL
  ) %>%
  dplyr::mutate(
    pais = dplyr::case_when(
      pais == "USA" ~ "United States",
      pais == "UK" ~ "United Kingdom",
      pais == "Tanzania" ~ "United Republic of Tanzania",
      pais == "West Germany" ~ "Germany",
      pais == "East Germany" ~ "Germany",
      pais == "Federal Republic of Yugoslavia" ~ "Yugoslavia",
      pais == "Soviet Union" ~ "Russian Federation",
      pais == "Russia" ~ "Russian Federation",
      pais == "The Democratic Republic Of Congo" ~ "Democratic Republic of The Congo",
      pais == "Korea" ~ "South Korea",
      pais == "Serbia and Montenegro" ~ "Montenegro",
      pais == "Côte d'Ivoire" ~ "Côte D’Ivoire",
      pais == "Isle Of Man" ~ "Isle of Man",
      pais == "North Vietnam" ~ "Vietnam",
      pais == "Myanmar" ~ "Myanmar/Burma",
      pais == "Republic of North Macedonia" ~ "North Macedonia",
      pais == "Czechoslovakia" ~ "Czechia",
      pais == "Czech Republic" ~ "Czechia",
      pais == pais ~ pais
    )
  ) %>%
  dplyr::rename(NAME_ENGL = pais) %>%
  dplyr::count(NAME_ENGL) %>%
  dplyr::full_join(sf_world) %>%
  dplyr::rename(
    pais = NAME_ENGL,
    qte_filmes = n
  ) %>%
  dplyr::mutate(
    qte_filmes = dplyr::coalesce(qte_filmes, 0)
  ) %>%
  dplyr::filter(!is.na(pais)) %>%
  dplyr::filter(pais != "Yugoslavia") %>%
  dplyr::arrange(desc(qte_filmes))

qte_filmes_pais %>% 
  dplyr::select(pais, qte_filmes) %>% 
  dplyr::filter(qte_filmes > 3500) %>% 
  knitr::kable()

```

Vamos destacar no mapa os 5 países com mais filmes na base estudada.

```{r, echo=FALSE, fig.align='center', warning=FALSE}
ggplot2::ggplot(qte_filmes_pais, ggplot2::aes(fill = qte_filmes)) +
  ggplot2::geom_sf(ggplot2::aes(geometry = geometry)) +
  ggplot2::theme_bw() +
  ggplot2::scale_fill_gradient(
    low = "#FFFAFA",
    high = "#8B0000"
  ) +
  ggplot2::labs(
    title = "Os 5 paises com mais filmes",
    caption = "Fonte: IMDB",
    fill = "Quantidade \nFilmes"
  ) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      size = 22,
      face = "bold"),
    plot.caption = ggplot2::element_text(face = "italic")
  ) +
  gghighlight::gghighlight(qte_filmes > 3500) 

# ggplot2::coord_sf(
#   xlim = c(-20, 40),
#   ylim = c(30, 80),
#   expand = TRUE
# ) +
```
Os países com mais filmes são Estados Unidos, India, Reino Unido, França e Itália.

```{r, echo=FALSE, fig.align='center', warning=FALSE}
ggplot2::ggplot(qte_filmes_pais, ggplot2::aes(fill = qte_filmes)) +
  ggplot2::geom_sf(ggplot2::aes(geometry = geometry)) +
  ggplot2::theme_bw() +
  ggplot2::scale_fill_gradient(
    low = '#FF8C00',
    high = '#8B0000'
  ) +
  ggplot2::labs(
    title = "Os países europeus dentro dos 5 com mais filmes",
    caption = "Fonte: IMDB",
    fill = "Quantidade \nFilmes"
  ) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      size = 22,
      face = "bold"),
    plot.caption = ggplot2::element_text(face = "italic")
  ) +
  gghighlight::gghighlight(qte_filmes > 3500 & qte_filmes < 8000) +
  ggplot2::coord_sf(
    xlim = c(-10, 20),
    ylim = c(35, 65),
    expand = TRUE
  )
```

Podemos observar tanto na tabela quanto no mapa que os Estados Unidos possuem uma quantidade de filmes que é desproporcional em relação aos outros países, dessa forma para uma melhor visualização da escala de cores no mapa, vamos visualizar desconsiderando os Estados Unidos.

```{r, echo=FALSE, fig.align='center', warning=FALSE}
ggplot2::ggplot(qte_filmes_pais, ggplot2::aes(fill = qte_filmes)) +
  ggplot2::geom_sf(ggplot2::aes(geometry = geometry)) +
  ggplot2::theme_bw() +
  ggplot2::scale_fill_gradient(
    low = "#FFFAFA",
    high = "#8B0000"
  ) +
  ggplot2::labs(
    title = "Países com mais filmes (exceto EUA)",
    caption = "Fonte: IMDB",
    fill = "Quantidade \nFilmes"
  ) +
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      size = 22,
      face = "bold"),
    plot.caption = ggplot2::element_text(face = "italic")
  ) +
  gghighlight::gghighlight(qte_filmes < 30000) 

```

## 3. Liste todas as moedas que aparecem nas colunas `orcamento` e `receita` da base `imdb_completa`.

Como poderemos ver abaixo, o dolar americano domina como sendo a principal moeda dos orçamentos dos filmes contidos na base estudada.

```{r, echo=FALSE, warning=FALSE}
imdb %>%
  dplyr::count(moeda_orcamento) %>%
  dplyr::filter(!is.na(moeda_orcamento)) %>%
  dplyr::rename(quantidade = n) %>% 
  dplyr::arrange(desc(quantidade)) %>% 
  dplyr::mutate(
    angle = 90 * sample(c(0, 1), dplyr::n(), replace = TRUE, prob = c(60, 40))
  ) %>%
  ggplot2::ggplot(ggplot2::aes(label = moeda_orcamento,
                               size = quantidade,
                               angle = angle,
                               color = quantidade)
  ) +
  ggwordcloud::geom_text_wordcloud_area(
    shape = 'square',
    seed = 100,
    area_corr_power = 1/1
  ) +
  ggplot2::scale_size_area(max_size = 70) +
  ggplot2::scale_color_gradient(
    low = '#0000FF', 
    high = '#FF0000') +
  ggplot2::theme_bw()

```

E também como sendo praticamente a moeda majoritária qunado se trata de receita dos filmes.

```{r, echo=FALSE, warning=FALSE}
imdb %>%
  dplyr::count(moeda_receita) %>%
  dplyr::filter(!is.na(moeda_receita)) %>%
  dplyr::arrange(desc(n)) %>% 
  knitr::kable()
```

